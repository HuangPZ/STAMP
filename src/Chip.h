
#pragma once
#include "tools.h"
#include "connect.h"
#include "globals.h"
using namespace std;

const int chip_package_len = 256;
// extern void log_print(string str);
class Chip
{
private:
    int counter_comm[2];
    // memset(counter_comm, 0, sizeof(counter_comm));
    int counter_loc;
public:
    // memset(counter_loc, 0, sizeof(counter_loc));


    int AddTimes,AddBits,CompareTimes,CompareBits,AESTimes,AESBits, multimes;
    int XORTimes, ReluTimes, Max_Comparetimes, SoftmaxTimes, LayerNormTimes;
    long int TransInBits,TransInTimes,TransOutBits,TransOutTimes;
    float ClockTime,Simtime;
    float AES_throughput,AES_latency,Add_gate_latency,frequency,Adder_numbers;
    int chip_partyNum;


    longType m_L[4];
    longType q_L[4];

    int fp;


	//Constructor and initializer
	Chip();
    void set_party(int partyNum);

	//Functions
    void Reset();
    void ChipGenMask(const vector<myType> & x, vector<myType>& x_dot, size_t size);
    void ChipGenMask(const vector<smallType> & x, vector<smallType>& x_dot, size_t size);
    void ChipGenMask(const vector<longType> & x, vector<longType>& x_dot, size_t size);
    void ChipGenMask(size_t size);
    void ChipGenShare(const vector<myType>& x, const RSSVectorMyType& x_share, RSSVectorMyType& x_dot, size_t size);
    void ChipGenShare(const vector<smallType>& x, const RSSVectorSmallType& x_share, RSSVectorSmallType& x_dot, size_t size);
    void ChipPC(const vector<myType>& x, const RSSVectorMyType& x_share, const vector<myType>& c, vector<smallType>& b, 
                        size_t size);
    void ChipPC(const vector<smallType>& x, const RSSVectorSmallType& x_share, const vector<smallType>& c, vector<smallType>& b, 
                        size_t size);
    void ChipReLU(const vector<myType>& x, const RSSVectorMyType& x_share, RSSVectorMyType& y, RSSVectorSmallType& b, 
                        size_t size);
    void ChipReLUP(const vector<myType>& x, const RSSVectorMyType& x_share, RSSVectorSmallType& b, 
                        size_t size);
    void ChipMax(const vector<myType>& x, const RSSVectorMyType &x_share, RSSVectorMyType &max, RSSVectorSmallType &maxPrime,
 						 size_t rows, size_t columns);
    void ChipMaxReLU(const vector<myType>& x, const vector<myType>& bias, RSSVectorMyType &max, RSSVectorSmallType &Prime, size_t truncation,
 						 size_t B, size_t tempSize, size_t Dout, bool maxpool, bool ReLU, bool BN, size_t poolSize, size_t stride_M, bool Is_CNN,
                          const vector<myType>&tempgamma, const vector<myType>&tempbeta);
    void ChipSoftmax(const vector<longType> q,const vector<longType> m_star,const vector<longType> m_3, 
    RSSVectorMyType& y, size_t rows, size_t columns, bool masked = false, size_t mask_ind = 0);
    void ChipLayerNorm(const vector<myType>& x, const RSSVectorMyType& x_share, RSSVectorMyType& y, 
                        size_t rows, size_t columns);
    void ChipBN(const RSSVectorMyType& a,const vector<myType>& recv_a,
                const RSSVectorMyType& gamma,const vector<myType>& recv_gamma,const RSSVectorMyType& beta, const vector<myType>& recv_beta, 
                RSSVectorMyType& b, size_t EPSILON, size_t m ,size_t B);
    unsigned int Chip_mask3[chip_package_len];
    unsigned int Chip_mask1[chip_package_len] = {
3414523378,
3467902347,
3175651854,
3394883171,
287484870,
3263465830,
3031399045,
3560308346,
308239234,
1693690886,
1047875213,
2816714625,
2177387105,
482511439,
196823340,
975820045,
1663745801,
3917045847,
1935807646,
2541219514,
589007123,
2569652280,
2919989028,
663975083,
2430120422,
2711957232,
5775010,
54822798,
2709559761,
3499614805,
1396835849,
1912473390,
4145151108,
1870521095,
3267782536,
559600281,
3050379204,
1234920828,
907067022,
1909880003,
193392500,
1191685390,
1846205594,
1466190024,
3113773542,
342731801,
1804989392,
1433723045,
1093386108,
527078439,
3921771102,
412498320,
3413866641,
392642852,
907379118,
673712336,
3691967667,
2926455456,
1031199842,
2895784995,
2463708702,
282347035,
2068590110,
3730311352,
221736085,
2173699425,
3864772635,
3940574119,
443644531,
1204706288,
1197127046,
2224422658,
1186426649,
2897901159,
1683421874,
1922172521,
2191503773,
3129052936,
3859155468,
1546524212,
820139720,
1264650810,
2626904546,
3289933848,
1953946980,
3439445546,
483018226,
1016164464,
2186431441,
4119349345,
3764856777,
3723425527,
3352062436,
278279289,
1895682281,
4256003624,
892047902,
251541207,
4164037055,
456477717,
3070186783,
2954907242,
637679718,
2080770005,
751495793,
4224262277,
43037231,
2402737792,
1141451159,
1661190582,
3225434877,
4096266924,
1473021552,
3381796533,
1224748392,
4124957056,
2602978271,
4239716438,
3664545456,
2143946834,
857280451,
1116792202,
1540575606,
2378601930,
3357743928,
1137929842,
4216498762,
1806678424,
1264992807,
591287155,
3625138425,
1298740661,
4229653793,
2960524126,
3676551604,
1780945963,
4082669699,
3503506339,
715845881,
1636754546,
3929648110,
101559692,
671491403,
1387479885,
1563659519,
4082705288,
4110088634,
3221764160,
1791213665,
4060424578,
1516520498,
742110090,
533064731,
3134311231,
3887217304,
3596236711,
2625777212,
1828879313,
2318864817,
735345006,
3875519171,
1539053835,
4186564825,
2027389350,
2773482460,
2440035852,
2001378689,
519412540,
694103911,
4093300683,
1346494849,
861608176,
2069904586,
4004671163,
389656361,
1689697699,
3022142992,
2380478575,
2197485101,
4187640350,
3381065555,
2503050324,
2090736721,
644133748,
954873716,
1543046767,
231517415,
4056114407,
160619806,
2887287599,
3417526808,
1820749914,
1077869329,
2359099203,
1597240057,
819863637,
1485133507,
1450464895,
2976420202,
2049367692,
2099199039,
968090834,
3635954375,
3173270010,
1362518623,
2182392898,
1923112538,
2230916997,
4136327750,
4245365490,
1826929828,
122089515,
3803301164,
1867879486,
706388591,
3987505086,
3568847734,
2533408726,
896709287,
1213650734,
542838806,
1438065138,
2890334724,
143017307,
3629652796,
1504972679,
1833117569,
3468978550,
1923479375,
2112393615,
1224533145,
3541418475,
455441207,
2948901467,
2860826709,
3249390298,
1475378411,
4272713709,
1138143271,
546914072,
2980046674,
2590320231,
103000460,
3194990275,
2378985071,
4273685886,
3702372219,
1399365211,
514186452,
1732711419,
2388717225,
1898926443,
63288682,
1921664074,
578050953,
2793104315};
unsigned int Chip_mask2[chip_package_len] = {
3563946787,
109017236,
4039632152,
1534039208,
110196909,
2025001025,
3721116890,
367590814,
61774261,
3642665671,
1393735376,
2811572464,
2365603243,
1306887688,
2484774876,
4103663076,
3386692148,
4224474705,
2156470297,
2132514564,
992936928,
1965249583,
1860747987,
3650101289,
940623156,
3824148085,
1545352295,
842938405,
3344962324,
2251200332,
1300061428,
1697668364,
1033835912,
983200622,
152141559,
179915283,
1423637469,
233615982,
3583795377,
2042686990,
1504621345,
268343085,
2813233016,
1240914317,
1623217661,
3516643162,
1426867160,
652596110,
2672948457,
3811143962,
2029850015,
1437729744,
3551008191,
2643318216,
2117365425,
1208541636,
52562342,
100014287,
571964364,
326620946,
266991705,
1447186850,
354654746,
1090274498,
2736537554,
3136430036,
2032996517,
1093491200,
2117044037,
1215529027,
1141744807,
2178804595,
3544228992,
2695553637,
1479360437,
1182939711,
598684322,
3664858289,
1343250115,
419649941,
858880306,
2476416806,
3804875018,
2297930216,
925893264,
3336553186,
3368996294,
2541052090,
3939696830,
2779796969,
2134837201,
3118642183,
4088749967,
1857102323,
2402444825,
3930275912,
3853198120,
2686414183,
1930557430,
3818008599,
2440196576,
368244073,
828488789,
2293542000,
4269828225,
3120570370,
649294532,
2826878083,
1466210269,
2227549551,
465317211,
4112661555,
2255997637,
1139191679,
79176318,
3039647777,
565474138,
194407958,
6946169,
2348531294,
3971014330,
2121490375,
991210751,
3542839986,
45944326,
3480350094,
2563796609,
2051274117,
2233455564,
2811181218,
1452119388,
3645647967,
1314428100,
2299066727,
100224238,
4069079813,
119851758,
2144177785,
3259651196,
1661877303,
3906087435,
2260536018,
2528998397,
3575810305,
1444938867,
522834449,
2805672121,
1188167087,
2627489604,
3352105432,
474073292,
2117626717,
2147640561,
3860408137,
4173405310,
2957452573,
2209047850,
1819918238,
3071683707,
1239504832,
2543440159,
765936347,
768066532,
2453248823,
3138634532,
4239972257,
688252228,
475589776,
2853757101,
253103894,
926953810,
1352990611,
558556582,
751765490,
3110665887,
3659110129,
2300143657,
2973210527,
3064766744,
2444644897,
1227568014,
1290258553,
2609258591,
3110084546,
2082036185,
4286168108,
1227643919,
304300974,
362404482,
4135764268,
139746507,
3026231194,
640777627,
73083462,
1832341815,
654224733,
460210767,
3494786900,
1588360642,
557078985,
109412289,
1455496709,
2600003157,
3304173353,
1895470916,
3871736262,
515446998,
306708052,
1940707056,
526739915,
2566487952,
4068537697,
2085940116,
497976357,
1999999595,
2681328371,
3423863040,
827606279,
3901111823,
4173702438,
457207730,
2755866907,
1556772820,
2560049936,
1326814935,
2251383282,
1460041113,
4089540585,
693518767,
464524188,
3315058802,
1443452612,
743094087,
2763770442,
1395546417,
288706026,
1926058902,
3308117792,
2763785681,
2373947604,
1347569902,
231211794,
381574837,
1520590774,
201386192,
316147429,
2741486280,
4128814003,
1343132436,
1101526863,
2269043065,
3571218083,
1335175802,
3692321834,
3603769747,
2022239612};

};

